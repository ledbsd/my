Именование Rules

Для Rules у Prometheus имеются рекомендации по именованию правил, что упрощает интерпретацию значения правила.

1. Разделителем в имени правила является ":"

2. Общий вид имени должен быть таким:

level:metric:operations

level – отражает уровень агрегации на основании labels. Он должен включать метку job и другие значимые labels, которые имеют отношение к метрике.

metric – это имя метрики. Допускается удаление _total, но в остальных случаях это должно быть точное название исходной метрики. Для обозначения необходимо использовать _per_.

operations – представляет собой список функций и агрегаций, примененных к метрике. Если применяется несколько одинаковых функций, например min, указывать необходимо только одну.

Для лучшего понимания ниже приведено несколько примеров:

- record: instance_path:request_latency_seconds_count:rate5m
  expr: rate(request_latency_seconds_count{job="myjob"}[5m])


- record: instance_path:request_latency_seconds_sum:rate5m
  expr: rate(request_latency_seconds_sum{job="myjob"}[5m])


- record: job:request_failures_per_requests:ratio_rate5m
  expr: |2
      sum without (instance, path)(instance_path:request_failures:rate5m{job="myjob"})
    /
      sum without (instance, path)(instance_path:requests:rate5m{job="myjob"})

Антипаттерны для использования Rules

Правила – очень мощный инструмент, но использовать их надо с осторожностью. Есть несколько антипаттернов использования правил.

1. Не стоит перемещать значения labels в название правил, это существенно сократит возможность обработки данных в дальнейшем.

2. Не стоит использовать rules для всех данных по умолчанию, это приведет к дополнительным накладным расходам. Как правило, 90% метрик не используются в повседневной работе и к ним обращаются только когда ищут источник проблем. Единственно когда, можно добавить правило - если без него запрос выполняется намного дольше.

3. Не стоит использовать rules для исправления имен или labels. Новый временной ряд записывается с новой временной меткой и приводит к потере исходной временной метрики.